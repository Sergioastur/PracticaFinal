<?php
session_start();
$_SESSION['pagina'] = "tabla";
include '../../connection/conexion.php';

// Verificar si el usuario está autenticado
if (!isset($_SESSION['usuario'])) {
    header("Location: ../../index.php");
    exit;
}

// Conexion a la base de datos
$conn = new mysqli($servidor, $usuario, $password, $db);

// Verificar si la conexión fue exitosa
if ($conn->connect_error) {
    die("Conexión fallida: " . $conn->connect_error);
}

// Obtener el ID del usuario autenticado

$id_usu = $_SESSION['usuario'];
?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="d-flex">
    <?php include '../interface/sidebar.php'; ?>
    <div class="flex-grow-1 p-3">
        <h1>Tabla</h1>
        <form method="post" class="mb-4">
            <div class="row justify-content-center">
                <div class="col-auto">
                    <label for="month" class="form-label">Mes:</label>
                    <select class="form-select" id="month" name="month">
                        <?php
                        $months = [1 => 'Enero', 2 => 'Febrero', 3 => 'Marzo', 4 => 'Abril',
                                   5 => 'Mayo', 6 => 'Junio', 7 => 'Julio', 8 => 'Agosto',
                                   9 => 'Septiembre', 10 => 'Octubre', 11 => 'Noviembre', 12 => 'Diciembre'];
                        foreach ($months as $key => $value) {
                            echo "<option value='$key'>$value</option>";
                        }
                        ?>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="year" class="form-label">Año:</label>
                    <input type="number" class="form-control" id="year" name="year" min="2023" max="2025" value="2025">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary mt-4">Ver Reporte</button>
                </div>
            </div>
        </form>

        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Día</th>
                    <?php
                    $comidas = ['desayuno', 'comida', 'merienda', 'cena', 'aperitivo'];
                    foreach ($comidas as $comida) {
                        echo "<th>GL/1H ($comida)</th><th>RAC.</th><th>INSU.</th><th>GL/2H</th>";
                        echo "<th>HIPO GLU.</th><th>HORA</th>";
                        echo "<th>HIPER GLU.</th><th>HORA</th><th>CORR.</th>";
                    }
                    echo "<th>LENTA</th>";
                    ?>
                </tr>
            </thead>
            <tbody>
                <?php
                if ($_SERVER['REQUEST_METHOD'] == 'POST') {
                    $month = $_POST['month'];
                    $year = $_POST['year'];
                    $days = cal_days_in_month(CAL_GREGORIAN, $month, $year);
                    
                    for ($day = 1; $day <= $days; $day++) {
                        $fecha = "$year-$month-$day";
                        echo "<tr><td>$day</td>";
                        
                        foreach ($comidas as $comida) {
                            $query = "SELECT * FROM COMIDA WHERE id_usu = $id_usu AND fecha = '$fecha' AND tipo_comida = '$comida'";
                            $result = $conn->query($query);
                            $data = $result->fetch_assoc();
                            
                            $gl_1h = $data['gl_1h'] ?? '';
                            $raciones = $data['raciones'] ?? '';
                            $insulina = $data['insulina'] ?? '';
                            $gl_2h = $data['gl_2h'] ?? '';
                            
                            $query_hipo = "SELECT * FROM HIPOGLUCEMIA WHERE id_usu = $id_usu AND fecha = '$fecha' AND tipo_comida = '$comida'";
                            $result_hipo = $conn->query($query_hipo);
                            $hipo = $result_hipo->fetch_assoc();
                            
                            $hipo_glu = $hipo['glucosa'] ?? '';
                            $hipo_hora = $hipo['hora'] ?? '';
                            
                            $query_hiper = "SELECT * FROM HIPERGLUCEMIA WHERE id_usu = $id_usu AND fecha = '$fecha' AND tipo_comida = '$comida'";
                            $result_hiper = $conn->query($query_hiper);
                            $hiper = $result_hiper->fetch_assoc();
                            
                            $hiper_glu = $hiper['glucosa'] ?? '';
                            $hiper_hora = $hiper['hora'] ?? '';
                            $hiper_corr = $hiper['correccion'] ?? '';
                            
                            echo "<td>$gl_1h</td><td>$raciones</td><td>$insulina</td><td>$gl_2h</td>";
                            echo "<td>$hipo_glu</td><td>$hipo_hora</td>";
                            echo "<td>$hiper_glu</td><td>$hiper_hora</td><td>$hiper_corr</td>";
                        }
                        
                        $query_lenta = "SELECT lenta FROM CONTROL_GLUCOSA WHERE id_usu = $id_usu AND fecha = '$fecha'";
                        $result_lenta = $conn->query($query_lenta);
                        $lenta = $result_lenta->fetch_assoc()['lenta'] ?? '';
                        echo "<td>$lenta</td></tr>";
                    }
                }
                ?>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>
<?php $conn->close(); ?>
